<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="Coverage" >

  <!--<include buildfile="CoverageEye.Properties.xml" />-->

  <!--
	The following properties should be specified in the calling script.
	
	<property name="Coverage.ReportFolder" value="${BuildDirectory}\Coverage Reports"/>
  <property name="Coverage.UnitTestPackageInclude" value="" />
	-->

  <!-- The following properties are for internal use only -->
	
  <property name="Private.Coverage.ConfigFile" value="" />
  <property name="Private.Coverage.COMServer" value="" />
  <property name="Private.Coverage.CorProfiler" value="{18656C37-035D-41CD-82C2-85DEF2DD5F7B}" />

  <target name="Private.Coverage.GetConfigFile">
    <readregistry hive="ClassesRoot" key="CLSID\${Private.Coverage.CorProfiler}\InprocServer32\" property="Private.Coverage.COMServer"/>
    <property name="Private.Coverage.ConfigFile" value="${path::get-directory-name(Private.Coverage.COMServer)}\Configuration\CoverageConfiguration.xml" />
  </target>
  
	<target name="Private.Coverage.WriteConfiguration">
    <call target="Private.Coverage.GetConfigFile"/>
    
    <write file="${Private.Coverage.ConfigFile}" append="true">
      <text><?xml version="1.0"?>
<CoverageConfiguration targetNamespace="urn:CoverageConfiguration">
</text>
    </write>
    
    <foreach item="File" property="Private.Coverage.PrepareFor.AssemblyPath" >
      <in>
        <items refid="Coverage.Targets" />
      </in>
      <do>
        <write file="${Private.Coverage.ConfigFile}" append="true">
          <text>
            <Assembly Owner="bogas@nowhere.com" Description="${path::get-file-name-without-extension(Private.Coverage.PrepareFor.AssemblyPath)}" AssemblyName="${string::to-lower(path::get-file-name(Private.Coverage.PrepareFor.AssemblyPath))}" ReportDirectory="${Coverage.ReportFolder}"/>
          </text>
        </write>
      </do>
    </foreach>

    <write file="${Private.Coverage.ConfigFile}" append="true">
      <text>        <Asp Selected="false"/>
        <Services>
        </Services>
</CoverageConfiguration>
</text>
    </write>
	</target>

	<target name="Private.Coverage.MergeReports">
		<exec program="cemerge.exe" 
			basedir="${BuildDirectory}\Packages\CoverageEye\bin">
			<arg value="${Coverage.ReportFolder}\ConsolidatedReport.xml" />
			<arg value=".\" /><!-- This is a bogas value. -->
			<arg value="${Coverage.ReportFolder}\Report.*.xml" />
		</exec>
	</target>
	
  <target name="UnitTest.RunTests">
    <call target="Private.Coverage.WriteConfiguration"/>
    <exec program="${nant::get-assembly()}">
      <environment>
        <variable name="Cor_Enable_Profiling" value="1"/>
        <variable name="Cor_Profiler" value="${Private.Coverage.CorProfiler}"/>
      </environment>
      <arg line="-BuildFile:${Coverage.UnitTestPackageInclude}"/>
      <arg line="UnitTest.RunTests}"/>
    </exec>
    <call target="Private.Coverage.MergeReports"/>
  </target>

  <target name="UnitTest.SetUp">
    <call target="Private.Coverage.GetConfigFile"/>
    <delete verbose="True" >
      <fileset basedir="${Coverage.ReportsPath}" >
        <include name="*.*" />
      </fileset>
    </delete>
    <exec program="${nant::get-assembly()}">
      <arg line="-BuildFile:${Coverage.UnitTestPackageInclude}"/>
      <arg line="UnitTest.SetUp}"/>
    </exec>
  </target>

  <target name="UnitTest.TearDown">
    <exec program="${nant::get-assembly()}">
      <arg line="-BuildFile:${Coverage.UnitTestPackageInclude}"/>
      <arg line="UnitTest.TearDown}"/>
    </exec>
  </target>
</project>